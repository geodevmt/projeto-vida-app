name: ğŸ›¡ï¸ Security & Quality CI

# Dispara em qualquer push ou pull request na branch main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# --- PERMISSÃ•ES DE SEGURANÃ‡A (O ajuste do CodeQL) ---
permissions:
  contents: read
# ----------------------------------------------------

jobs:
  security-and-build:
    runs-on: ubuntu-latest

    steps:
    # 1. Baixa o cÃ³digo do repositÃ³rio
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Configura o Node.js (VersÃ£o 20 para Next.js 15+)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 3. Instala dependÃªncias
    - name: Install Dependencies
      run: npm ci

    # 4. Auditoria de SeguranÃ§a (Bloqueia se houver vulnerabilidade crÃ­tica)
    - name: ğŸ›¡ï¸ Security Audit (Dependencies)
      run: npm audit --audit-level=high

    # 5. VerificaÃ§Ã£o de Tipagem (TypeScript)
    - name: ğŸ“ TypeScript Check
      run: npx tsc --noEmit

    # 6. Teste de Build (Simula a Vercel)
    - name: ğŸ—ï¸ Build Test
      run: npm run build
      env:
        # VariÃ¡veis fake apenas para o build nÃ£o falhar por falta de config
        NEXT_PUBLIC_SUPABASE_URL: "https://example.supabase.co"
        NEXT_PUBLIC_SUPABASE_ANON_KEY: "fake-key-for-build-process"